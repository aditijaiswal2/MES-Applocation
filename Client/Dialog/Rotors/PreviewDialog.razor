 @using MES.Shared.Models.Rotors
@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime
@inject ISnackbar Snackbar
@using MES.Shared.DTOs
@using Newtonsoft.Json
@using System.Text
@inject HttpClient HttpClient
@inject IDialogService DialogService
@using MES.Client.Utitlity

@using System.Text.Json;

@using MES.Client.Dialog.QRPrint

<MudDialog MaxWidth="MaxWidth.ExtraLarge" FullWidth="true">
    <DialogContent>

        <MudPaper Class="pa-6" Style=" border-radius: 12px;" id="print-section">

            <MudGrid Spacing="2">

                <MudItem md="3" xs="12" class="outlined-box pa-2">
                    <MudText Typo="Typo.h6" Color="Color.Primary">Serial Number</MudText>
                    <MudText Typo="Typo.body1">@SelectedSerialNumber</MudText>
                </MudItem>
                <MudItem md="3" xs="12" class="outlined-box pa-2">
                    <MudText Typo="Typo.h6" Color="Color.Primary">Module</MudText>
                    <MudText Typo="Typo.body1">@SelectedModule</MudText>
                </MudItem>
                <MudItem md="3" xs="12" class="outlined-box pa-2">
                    <MudText Typo="Typo.h6" Color="Color.Primary">Customer</MudText>
                    <MudText Typo="Typo.body1">@InspectionData.Customer</MudText>
                </MudItem>

                <MudItem md="3" xs="12" class="outlined-box pa-2">
                    <MudText Typo="Typo.h6" Color="Color.Primary">Location</MudText>
                    <MudText Typo="Typo.body1">@InspectionData.Location</MudText>
                </MudItem>

            </MudGrid>

            <MudGrid Spacing="2">

              
                <MudItem md="3" xs="12" class="outlined-box pa-2">
                    <MudText Typo="Typo.h6" Color="Color.Primary">Received</MudText>
                    <MudText Typo="Typo.body1">@InspectionData.Received</MudText>
                </MudItem>
                <MudItem md="3" xs="12" class="outlined-box pa-2">
                    <MudText Typo="Typo.h6" Color="Color.Primary">Inspected</MudText>
                    <MudText Typo="Typo.body1">@InspectionData.Inspected</MudText>
                </MudItem>

                <MudItem md="3" xs="12" class="outlined-box pa-2">
                    <MudText Typo="Typo.h6" Color="Color.Primary">Rotors#</MudText>
                    <MudText Typo="Typo.body1">@InspectionData.RotorsNumber</MudText>
                </MudItem>

                <MudItem md="3" xs="12" class="outlined-box pa-2">
                    <MudText Typo="Typo.h6" Color="Color.Primary">Make</MudText>
                    <MudText Typo="Typo.body1">@selectedMake</MudText>
                </MudItem>
            </MudGrid>

          

            <MudGrid Spacing="2">

                <MudItem md="3" xs="12" class="outlined-box pa-2">
                    <MudText Typo="Typo.h6" Color="Color.Primary">Dia</MudText>
                    <MudText Typo="Typo.body1">@InspectionData.Dia</MudText>
                </MudItem>
                <MudItem md="3" xs="12" class="outlined-box pa-2">
                    <MudText Typo="Typo.h6" Color="Color.Primary">Len</MudText>
                    <MudText Typo="Typo.body1">@InspectionData.Len</MudText>
                </MudItem>
                <MudItem md="3" xs="12" class="outlined-box pa-2">
                    <MudText Typo="Typo.h6" Color="Color.Primary">Fits</MudText>
                    <MudText Typo="Typo.body1">@InspectionData.Fits</MudText>
                </MudItem>
                <MudItem md="3" xs="12" class="outlined-box pa-2">
                    <MudText Typo="Typo.h6" Color="Color.Primary">Materials</MudText>
                    <MudText Typo="Typo.body1">@SelectedMaterial</MudText>
                </MudItem>

            </MudGrid>

            <MudGrid Spacing="2">

                <MudItem md="3" xs="12" class="outlined-box pa-2">
                    <MudText Typo="Typo.h6" Color="Color.Primary">Others</MudText>
                    <MudText Typo="Typo.body1">@SelectedOthers</MudText>
                </MudItem>
                <MudItem md="3" xs="12" class="outlined-box pa-2">
                    <MudText Typo="Typo.h6" Color="Color.Primary">Rotor Dia.</MudText>
                    <MudText Typo="Typo.body1">@InspectionData.RotorsDia</MudText>
                </MudItem>
                <MudItem xs="12" md="3" class="outlined-box">
                    <MudText Typo="Typo.h6" Color="Color.Primary">Rotor Style</MudText>
                    <MudText Typo="Typo.body1">@SelectedRotorStyle</MudText>
                </MudItem>
                <MudItem xs="12" md="3" class="outlined-box pa-2">
                    <MudText Typo="Typo.h6" Color="Color.Primary">Type</MudText>
                    <MudText Typo="Typo.body1">@SelectedType</MudText>
                </MudItem>

             
            </MudGrid>

            <MudGrid Spacing="2">

                <MudItem xs="12" md="3" class="outlined-box pa-2">
                    <MudText Typo="Typo.h6" Color="Color.Primary">Bearing Removed</MudText>
                    <MudText Typo="Typo.body1">@Selectedberrem</MudText>
                </MudItem>

                <MudItem xs="12" md="3" class="outlined-box pa-2">
                    <MudText Typo="Typo.h6" Color="Color.Primary">Bearings</MudText>
                    <MudText Typo="Typo.body1">@SelectedBearings</MudText>
                </MudItem>

                <MudItem xs="12" md="3" class="outlined-box pa-2">
                    <MudText Typo="Typo.h6" Color="Color.Primary">Bearing Seals</MudText>
                    <MudText Typo="Typo.body1">@SelectedBearSeals</MudText>
                </MudItem>

                <MudItem xs="12" md="3" class="outlined-box pa-2">
                    <MudText Typo="Typo.h6" Color="Color.Primary">Ceramic Seals</MudText>
                    <MudText Typo="Typo.body1">@SelectedCerSeals</MudText>
                </MudItem>

            </MudGrid>

            <MudGrid Spacing="2">

              

                <MudItem xs="12" md="3" class="outlined-box pa-2">
                    <MudText Typo="Typo.h6" Color="Color.Primary">Bearing Journal Dia (Right)</MudText>
                    <MudText Typo="Typo.body1">@SelectedRL</MudText>
                    <MudText Typo="Typo.body1">Bearing Journal Dia (Right Details): @InspectionData.yRight</MudText>
                </MudItem>

                <MudItem xs="12" md="3" class="outlined-box pa-2">
                    <MudText Typo="Typo.h6" Color="Color.Primary">Bearing Journal Dia (Left)</MudText>
                    <MudText Typo="Typo.body1">@SelectedLR</MudText>
                    <MudText Typo="Typo.body1">Bearing Journal Dia (Left Details): @InspectionData.yLeft</MudText>
                </MudItem>
                <MudItem xs="12" md="3" class="outlined-box pa-2">
                    <MudText Typo="Typo.h6" Color="Color.Primary">Basic Sharpening</MudText>
                    <MudText Typo="Typo.body1">@Selectedbs</MudText>

                    @if (Selectedbs == "Yes")
                    {
                        <MudText Typo="Typo.h6" Color="Color.Primary">Basic Sharpening Detail</MudText>
                        <MudText Typo="Typo.body1">@Selectedybasicsharp</MudText>
                    }
                </MudItem>
                <MudItem xs="12" md="3" class="outlined-box pa-2">
                    <MudText Typo="Typo.h6" Color="Color.Primary">Wedgelock Alignment Marks Present</MudText>
                    <MudText Typo="Typo.body1">@Selectedpre</MudText>
                </MudItem>
            </MudGrid>

            <MudGrid Spacing="2">

               
                <MudItem xs="12" md="3" class="outlined-box pa-2">
                    <MudText Typo="Typo.h6" Color="Color.Primary">Center Grinding</MudText>
                    <MudText Typo="Typo.body1">@Selectedctr</MudText>

                </MudItem>
                <MudItem xs="12" md="3" class="outlined-box pa-2">
                   @if (Selectedctr == "Yes")
        {
            <MudText Typo="Typo.h6" Color="Color.Primary">Center Grinding Details</MudText>
            <MudText Typo="Typo.body1">@Selectedycg</MudText>
        }
    </MudItem>

                <MudItem xs="12" md="3" class="outlined-box pa-2">
                    <MudText Typo="Typo.h6" Color="Color.Primary">Aligned</MudText>
                    <MudText Typo="Typo.body1">@Selectedalign</MudText>
                </MudItem>

                <MudItem xs="12" md="3" class="outlined-box pa-2">
                    <MudText Typo="Typo.h6" Color="Color.Primary">Plastic Sleeves</MudText>
                    <MudText Typo="Typo.body1">@Selectedyps</MudText>
                </MudItem>
            </MudGrid>

            <MudGrid Spacing="2">

                <MudItem xs="12" md="3" class="outlined-box pa-2">
                    <MudText Typo="Typo.h6" Color="Color.Primary">Welding</MudText>
                    <MudText Typo="Typo.body1">@Selectedwelding</MudText>

                </MudItem>

                 <MudItem xs="12" md="3" class="outlined-box pa-2">
                @if (Selectedwelding == "Yes")
                {
                    <MudText Typo="Typo.h6" Color="Color.Primary">Welding Number</MudText>
                    <MudText Typo="Typo.body1">@InspectionData.WeldingNum</MudText>
                }
                </MudItem>

                <MudItem xs="12" md="3" class="outlined-box pa-2">
                    <MudText Typo="Typo.h6" Color="Color.Primary">Bed Knife in Box</MudText>
                    <MudText Typo="Typo.body1">@Selectebkid</MudText>
                </MudItem>

                <MudItem xs="12" md="3" class="outlined-box pa-2">
                    <MudText Typo="Typo.h6" Color="Color.Primary">Replace Blades</MudText>
                    <MudText Typo="Typo.body1">@selectedRB</MudText>
                </MudItem>

            </MudGrid>

            <MudGrid Spacing="2">

                <MudItem xs="12" md="3" class="outlined-box pa-2">
                    <MudText Typo="Typo.h6" Color="Color.Primary">Re-Profile</MudText>
                    <MudText Typo="Typo.body1">@Selectedrp</MudText>

                </MudItem>

                <MudItem xs="12" md="3" class="outlined-box pa-2">
                    <MudText Typo="Typo.h6" Color="Color.Primary">Manual Labor</MudText>
                    <MudText Typo="Typo.body1">@selectedManualLabour</MudText>
                </MudItem>

                <MudItem xs="12" md="3" class="outlined-box pa-2">
                    <MudText Typo="Typo.h6" Color="Color.Primary">Box Received with Saddles (Down)</MudText>
                    <MudText Typo="Typo.body1">@Selectedbt</MudText>

                </MudItem>

                <MudItem xs="12" md="3" class="outlined-box pa-2">
                    <MudText Typo="Typo.h6" Color="Color.Primary">Box Received with Saddles (Top)</MudText>
                    <MudText Typo="Typo.body1">@Selectedtb</MudText>
                </MudItem>

            </MudGrid>

            <MudGrid Spacing="2">

                <MudItem xs="12" md="3" class="outlined-box pa-2">
                    <MudText Typo="Typo.h6" Color="Color.Primary">Add QTY</MudText>
                    <MudText Typo="Typo.body1">@InspectionData.AddQty</MudText>
                </MudItem>

                <MudItem xs="12" md="3" class="outlined-box pa-2">
                    <MudText Typo="Typo.h6" Color="Color.Primary">Saddle Part Number</MudText>
                    <MudText Typo="Typo.body1">@SelectedSaddlePartNumber</MudText>

                </MudItem>

                <MudItem xs="12" md="3" class="outlined-box pa-2">
                    <MudText Typo="Typo.h6" Color="Color.Primary">Rotor Categorize  </MudText>
                    <MudText Typo="Typo.body1">@Selectedddrc</MudText>
                </MudItem>

                <MudItem xs="12" md="3" class="outlined-box">
                    <MudText Typo="Typo.h6" Color="Color.Primary">Sub-Module</MudText>
                    <MudText Typo="Typo.body1">@Selecteddd</MudText>
                </MudItem>

            </MudGrid>
          
        </MudPaper>

    </DialogContent>

    <DialogActions>
        <MudButton OnClick="PrintDialog" Color="Color.Primary">Print</MudButton>
        <MudButton OnClick="CloseDialog" Color="Color.Primary">Close</MudButton>
    </DialogActions>
</MudDialog>

<style>


    .outlined-box .mud-text {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    }


    .outlined-box {

    border-radius: 8px;
    padding: 16px;
    }


    #print-section {
    background-color: #2a2a2a; /* Dark section background */
    padding: 14px;
    border-radius: 16px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.6);
    color: #ffffff; /* White text */
    }

</style>



@code {
    [Parameter]
    public IncomingInspection InspectionData { get; set; }

    [Parameter]
    public string SelectedMaterial { get; set; }    
    [Parameter]
    public string selectedRB { get; set; }
  
    [Parameter]
    public string selectedMake { get; set; }
    [Parameter]
    public string selectedManualLabour { get; set; }
    [Parameter] public string SelectedType { get; set; }
    [Parameter] public string SelectedOthers { get; set; }
    [Parameter] public string SelectedSaddlePartNumber { get; set; }
    [Parameter] public string SelectedRotorStyle { get; set; }
    [Parameter] public string Selectedberrem { get; set; }
    [Parameter] public string SelectedBearings { get; set; }
    [Parameter] public string SelectedBearSeals { get; set; }
    [Parameter] public string SelectedCerSeals { get; set; }
    [Parameter] public string SelectedRL { get; set; }
    [Parameter] public string SelectedLR { get; set; }
    [Parameter] public string Selectedbs { get; set; }
    [Parameter] public string Selectedybasicsharp { get; set; }
    [Parameter] public string Selectedpre { get; set; }
    [Parameter] public string Selectedctr { get; set; }
    [Parameter] public string Selectedycg { get; set; }
    [Parameter] public string Selectedalign { get; set; }
    [Parameter] public string Selectedyps { get; set; }
    [Parameter] public string Selectedwelding { get; set; }
    [Parameter] public string Selectebkid { get; set; }
    [Parameter] public string Selectedrp { get; set; }
    [Parameter] public string Selectedsb { get; set; }
    [Parameter] public string Selectedbt { get; set; }
    [Parameter] public string Selectedtb { get; set; }
    [Parameter] public string Selectedddrc { get; set; }
    [Parameter] public string Selecteddd { get; set; }
    [Parameter] public string SelectedSerialNumber { get; set; }
    [Parameter] public string SelectedModule { get; set; }
    [CascadingParameter]
    MudDialogInstance MudDialog { get; set; }
    public QrDTO LocQR { get; set; }



    private List<(string label, string value)> GetInspectionFields()
    {
        return new List<(string, string)>
    {
      
        ("Customer", InspectionData.Customer),
        ("Location", InspectionData.Location),
        ("Received", InspectionData.Received),
        ("Inspected", InspectionData.Inspected),
        ("Rotors#", InspectionData.RotorsNumber),
        ("Initial", InspectionData.Initials),
        ("Make", InspectionData.Make),
        ("Dia", InspectionData.Dia),
        ("Len", InspectionData.Len),
        ("Fits", InspectionData.Fits),
        ("Materials", SelectedMaterial),
        ("Others", InspectionData.Others),
        ("Rotors Dia", InspectionData.RotorsDia),
        ("Rotors Style", SelectedRotorStyle),
        ("Type", SelectedType),

        ("Bearing Removed", Selectedberrem),
        ("Bearings", SelectedBearings),
        ("Bearing Seals",SelectedBearSeals),
        ("Ceramic Seals", SelectedCerSeals),
        ("Bearing Journal Dia (Right)", SelectedRL),
        ("Bearing Journal Dia Details (Right)", InspectionData.yRight),
        ("Bearing Journal Dia (Left)", SelectedLR),
        ("Bearing Journal Dia Details (Left)", InspectionData.yLeft),
        ("Basic Sharpening", Selectedbs),
        ("Basic Sharpening Details", Selectedybasicsharp),
        ("Wedgelock Alignment Marks; Present", Selectedpre),
         ("Center Grinding", Selectedctr),
        ("Center Grinding Details", Selectedycg),
        ("Aligned", Selectedalign),
        ("Plastic Sleaves", Selectedyps),
        ("Welding", Selectedwelding),
        ("No. of Welding", InspectionData.WeldingNum),
        ("Bed Knife in box", Selectebkid),
        ("Replace Blades", InspectionData.BoxReceivedWithSaddles),
        ("Re-Profile", Selectedrp),
        ("Sand Blasting", Selectedsb),
        ("Manual Labor", InspectionData.ManualLabor),
        ("Box Received with Saddles(Bottom)", Selectedbt),
        ("Box Received with Saddles(Top)", Selectedtb),
        ("Add QTY", InspectionData.AddQty?.ToString()),
        ("Saddle Part Number", InspectionData.SaddlePartNumber),
        ("Rotor Categorize", Selectedddrc),
        ("Sub Module", Selecteddd),
    };
    }

    private IEnumerable<List<(string label, string value)>> ChunkFields(List<(string label, string value)> fields, int size)
    {
        for (int i = 0; i < fields.Count; i += size)
        {
            yield return fields.Skip(i).Take(size).ToList();
        }
    }

    async void PrintDialog()
    {
        var receive = new QRRequestDTO
            {
                SerialNumber = SelectedSerialNumber,
                Module = SelectedModule,
                Customer = InspectionData.Customer,
                Date = DateTime.Now // or whatever date format you need
            };

        await GenerateQR(receive);
        //  await JSRuntime.InvokeVoidAsync("printDiv", "print-section");


    }


    public async Task GenerateQR(QRRequestDTO receive)
    {
        Snackbar.Clear();
        Snackbar.Configuration.PositionClass = Defaults.Classes.Position.TopCenter;

        try
        {

            string receiveData = $"Serial Number: {receive.SerialNumber},Module: {receive.Module}, Customer: {receive.Customer}, Date: {receive.Date}";


            var jsonPart = JsonConvert.SerializeObject(receive);
            var content = new StringContent(jsonPart, Encoding.UTF8, "application/json");

            // Serialize receiving data
            if (string.IsNullOrWhiteSpace(Selectedddrc) || string.IsNullOrWhiteSpace(Selecteddd) || string.IsNullOrWhiteSpace(InspectionData.Customer) || string.IsNullOrWhiteSpace(InspectionData.Location) || string.IsNullOrWhiteSpace(InspectionData.RotorsNumber) )
            {
                Snackbar.Add("Please fill in all the mandatory fields before print.", Severity.Warning);
                return;
            }



            //   var response = await HttpClient.PostAsync("https://localhost:7172/api/QRCode/IncomlocQR", content);
            var response = await HttpClient.PostAsync(ApiConstants.AddprintQRCode, content);
            byte[] qrCodeBytes = null;



            if (response.IsSuccessStatusCode)
            {
                using (var stream = await response.Content.ReadAsStreamAsync())
                using (var memoryStream = new MemoryStream())
                {
                    await stream.CopyToAsync(memoryStream);
                    qrCodeBytes = memoryStream.ToArray();
                }

                // Convert image to Base64 string
                string base64Image = Convert.ToBase64String(qrCodeBytes);
                string imageDataUrl = $"data:image/png;base64,{base64Image}";

                // Define the text to show under the QR code
                string labelText = $"SN: {receive.SerialNumber}";

                // Call JS function to print image
                await JSRuntime.InvokeVoidAsync("printincomingImage", imageDataUrl, labelText);
            }
            else
            {

                Snackbar.Add($"QR code generation failed with status code: {response.StatusCode}", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error generating QR code: {ex.Message}", Severity.Error);
        }
    }

    void CloseDialog()
    {
        MudDialog.Cancel();
    }




}
